version: 0.2


phases:
  install:
    runtime-versions:
      python: 3.7

  build:
    commands:
      - IMAGE_REPO="$(aws sts get-caller-identity --query Account --output text).dkr.ecr.${AWS_REGION}.amazonaws.com/searchapi-devel-staging"
      - yum upgrade -y
      # Inject the github hash to version file, so you can check if deployed on the health endpoint.
      - echo "{\"version\":\"${CODEBUILD_RESOLVED_SOURCE_VERSION}\"}" > SearchAPI/version.json
      - sam build
      # Make sure "latest" tag gets updated too. `sam deploy` only pushes a image with a weird hash, so each one is unique.
      - docker tag "searchapifunction:sam_image" "${IMAGE_REPO}:latest" && docker push "${IMAGE_REPO}:latest"
      - sam deploy --region ${AWS_REGION} --stack-name SearchAPI-devel-staging --image-repository ${IMAGE_REPO} --tags KeyName1=SAM_SearchAPI --capabilities CAPABILITY_IAM --no-fail-on-empty-changeset
